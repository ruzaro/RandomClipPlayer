<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Twitch Clip Player Config</title>
</head>
<body>
<h1>Twitch Clip Player Config</h1>

<p>Select the <code>config.txt</code> file. After saving make sure you place it next to <code>clipPlayer.html</code>!</p>

<div>
    <div id="fileSelection">
        <button id="selectFile">ðŸ“‚ Select config.txt</button><br><br>
    </div>
    <div id="fileForm">
        <form id="configForm">
            <label>Client ID: <input name="CLIENT_ID" required> retrieved from https://dev.twitch.tv/ </label><br><br>
            <label>Client secret: <input name="CLIENT_SECRET" required> retrieved from https://dev.twitch.tv/ </label><br><br>
            <label>Twitch channel name: <input name="BROADCASTER_NAME" required></label><br><br>
            <label>Top/Random
                <select name="TOP_OR_RANDOM">
                    <option value="random" selected>Random</option>
                    <option value="top">Top</option>
                </select>
            </label><br><br>
            <label>Maximum number of clips: <input name="MAX_CLIPS" type="number" min="0" value="1000"></label><br><br>
            <label>Volume: <input name="VOLUME_PERCENT" type="range" value="50" min="0" max="100"></label><br><br>
            <label><input type="checkbox" name="SHOW_CLIP_CREATORS" checked> Show the author</label><br>
            <label><input type="checkbox" name="SHOW_CLIP_GAME" checked> Show the game</label><br>
            <label><input type="checkbox" name="SHOW_CLIP_TITLE" checked> Show the title</label><br><br>
            <label>Description author prefix: <input name="DESC_AUTHOR_PREFIX" required value="Author: "></label><br><br>
            <label>Description game prefix: <input name="DESC_GAME_PREFIX" required value="Game: "></label><br><br>

            <button id="save" type="submit">Save config.txt</button>
        </form>
    </div>
</div>

<script src="common.js"></script>
<script>
    let fileHandle = null;

    document.getElementById("selectFile").addEventListener("click", async () => {
        [fileHandle] = await window.showOpenFilePicker({
            types: [{
                description: 'Text Files',
                accept: { 'text/plain': ['.txt'] }
            }]
        });

        if (!fileHandle) {
            FileForm.hide();
            return;
        }

        const file = await fileHandle.getFile();
        const text = await file.text();

        const globalConfig = await parseGlobalConfig(text);

        loadToForm(globalConfig);

        FileForm.show();
    });

    document.getElementById("configForm").addEventListener("submit", async function(e) {
        e.preventDefault();

        if (!fileHandle) {
            alert("File not selected!");
            return;
        }

        const form = new FormData(e.target);

        let config = "";

        for (const [key, value] of form.entries()) {
            if (CHECKBOX_KEYS.includes(key)) {
                config += key + "=true\n";
            } else {
                config += key + "=" + value + "\n";
            }
        }

        CHECKBOX_KEYS.forEach(k => {
            if (!form.has(k)) config += k + "=false\n";
        });

        const writable = await fileHandle.createWritable();
        await writable.write(config);
        await writable.close();
    });

    function loadToForm(globalConfig){
        const form = document.getElementById("configForm");

        for (const [key, value] of Object.entries(globalConfig)) {
            const input = form.elements[key];
            if (!input) return;

            if (input.type === "checkbox") {
                input.checked = value.trim() === "true";
            } else {
                input.value = value.trim();
            }
        }
    }

    class FileForm {
        static show() {
            const form = document.getElementById("fileForm");
            form.style.display = 'block';
        }

        static hide() {
            const form = document.getElementById("fileForm");
            form.style.display = 'none';
        }
    }

    async function onLoad(){
        FileForm.hide();
    }

    window.addEventListener("load", onLoad);
</script>
</body>
</html>
